{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://mcpflow.io/schema/0.1/schema.json",
  "title": "MCP-Flow Transport Schema",
  "description": "Transport-layer types for MCP-Flow, a WebTransport binding for the Model Context Protocol.",
  "definitions": {
    "Encoding": {
      "description": "Supported wire encodings for Control Stream messages.",
      "type": "string",
      "enum": ["json", "cbor"]
    },

    "StreamHeader": {
      "description": "Header that MUST appear at the start of every Execution Stream. Total size: 8 bytes.",
      "type": "object",
      "properties": {
        "requestId": {
          "description": "The JSON-RPC request `id` this stream is associated with. Encoded as big-endian Uint32 (bytes 0-3).",
          "type": "integer",
          "minimum": 0,
          "maximum": 4294967295
        },
        "streamTag": {
          "description": "Application-assigned tag for multi-stream responses. Encoded as big-endian Uint32 (bytes 4-7).",
          "type": "integer",
          "minimum": 0,
          "maximum": 4294967295
        }
      },
      "required": ["requestId", "streamTag"],
      "additionalProperties": false
    },

    "StreamReference": {
      "description": "Reference to data delivered via an Execution Stream. Used in JSON-RPC response `content` arrays.",
      "type": "object",
      "properties": {
        "type": {
          "description": "Discriminator for stream references.",
          "const": "ref/stream",
          "type": "string"
        },
        "streamTag": {
          "description": "The stream tag from the Execution Stream header.",
          "type": "integer",
          "minimum": 0,
          "maximum": 4294967295
        },
        "mimeType": {
          "description": "MIME type of the streamed content.",
          "type": "string"
        }
      },
      "required": ["type", "streamTag", "mimeType"],
      "additionalProperties": false
    },

    "DatagramChannelId": {
      "description": "Channel identifiers for datagram multiplexing.",
      "type": "integer",
      "enum": [0, 1, 2, 3],
      "x-enum-descriptions": {
        "0": "Reserved",
        "1": "Progress",
        "2": "Audio",
        "3": "Log"
      }
    },

    "DatagramHeader": {
      "description": "Header that MUST appear at the start of every datagram. Total size: 6 bytes.",
      "type": "object",
      "properties": {
        "channelId": {
          "$ref": "#/definitions/DatagramChannelId",
          "description": "Channel identifier (byte 0)."
        },
        "flags": {
          "description": "Reserved flags for future use (byte 1). MUST be 0x00.",
          "const": 0,
          "type": "integer"
        },
        "requestId": {
          "description": "The JSON-RPC request `id` this datagram relates to (bytes 2-5). Use 0 for session-global datagrams.",
          "type": "integer",
          "minimum": 0,
          "maximum": 4294967295
        }
      },
      "required": ["channelId", "flags", "requestId"],
      "additionalProperties": false
    },

    "ClientTransportCapabilities": {
      "description": "Transport metadata sent by the client in the `initialize` request.",
      "type": "object",
      "properties": {
        "type": {
          "description": "Transport type identifier.",
          "const": "mcp-flow",
          "type": "string"
        },
        "version": {
          "description": "MCP-Flow protocol version.",
          "type": "string"
        },
        "encodings": {
          "description": "Supported encodings, ordered by preference. If omitted, server defaults to 'json'.",
          "type": "array",
          "items": {
            "$ref": "#/definitions/Encoding"
          },
          "minItems": 1
        }
      },
      "required": ["type", "version"],
      "additionalProperties": false
    },

    "ServerTransportCapabilities": {
      "description": "Transport metadata sent by the server in the `initialize` response.",
      "type": "object",
      "properties": {
        "type": {
          "description": "Transport type identifier.",
          "const": "mcp-flow",
          "type": "string"
        },
        "version": {
          "description": "MCP-Flow protocol version.",
          "type": "string"
        },
        "encoding": {
          "$ref": "#/definitions/Encoding",
          "description": "The encoding selected by the server. All subsequent Control Stream messages use this encoding."
        },
        "maxConcurrentStreams": {
          "description": "Maximum number of concurrent Execution Streams allowed.",
          "type": "integer",
          "minimum": 1
        },
        "datagramsSupported": {
          "description": "Whether the server supports WebTransport datagrams.",
          "type": "boolean"
        }
      },
      "required": ["type", "version", "encoding", "maxConcurrentStreams", "datagramsSupported"],
      "additionalProperties": false
    },

    "StreamErrorNotification": {
      "description": "Notification sent when an Execution Stream encounters an error.",
      "type": "object",
      "properties": {
        "jsonrpc": {
          "const": "2.0",
          "type": "string"
        },
        "method": {
          "const": "$/streamError",
          "type": "string"
        },
        "params": {
          "type": "object",
          "properties": {
            "requestId": {
              "description": "The request ID of the failed stream.",
              "type": "integer",
              "minimum": 0,
              "maximum": 4294967295
            },
            "streamTag": {
              "description": "The stream tag of the failed stream.",
              "type": "integer",
              "minimum": 0,
              "maximum": 4294967295
            },
            "error": {
              "description": "Human-readable error description.",
              "type": "string"
            }
          },
          "required": ["requestId", "streamTag", "error"],
          "additionalProperties": false
        }
      },
      "required": ["jsonrpc", "method", "params"],
      "additionalProperties": false
    },

    "ShutdownNotification": {
      "description": "Notification sent to initiate graceful shutdown.",
      "type": "object",
      "properties": {
        "jsonrpc": {
          "const": "2.0",
          "type": "string"
        },
        "method": {
          "const": "$/shutdown",
          "type": "string"
        }
      },
      "required": ["jsonrpc", "method"],
      "additionalProperties": false
    },

    "CancelNotification": {
      "description": "Notification sent to cancel an in-flight request. The request SHOULD still be in-flight, but due to communication latency, this notification MAY arrive after the request has already finished.",
      "type": "object",
      "properties": {
        "jsonrpc": {
          "const": "2.0",
          "type": "string"
        },
        "method": {
          "const": "$/cancel",
          "type": "string"
        },
        "params": {
          "type": "object",
          "properties": {
            "requestId": {
              "description": "The ID of the request to cancel. MUST correspond to the ID of a request previously issued.",
              "type": "integer",
              "minimum": 0,
              "maximum": 4294967295
            },
            "reason": {
              "description": "Optional reason for the cancellation. MAY be logged or presented to the user.",
              "type": "string"
            }
          },
          "required": ["requestId"],
          "additionalProperties": false
        }
      },
      "required": ["jsonrpc", "method", "params"],
      "additionalProperties": false
    },

    "McpFlowNotification": {
      "description": "Union of all MCP-Flow specific notifications.",
      "anyOf": [
        { "$ref": "#/definitions/StreamErrorNotification" },
        { "$ref": "#/definitions/ShutdownNotification" },
        { "$ref": "#/definitions/CancelNotification" }
      ]
    },

    "ControlStreamFrame": {
      "description": "Length-prefixed message frame for the Control Stream. All messages MUST be wrapped in this frame.",
      "type": "object",
      "properties": {
        "length": {
          "description": "Message length in bytes (big-endian Uint32). Maximum: 4,294,967,295 bytes.",
          "type": "integer",
          "minimum": 0,
          "maximum": 4294967295
        },
        "body": {
          "description": "The JSON or CBOR encoded RPC message body.",
          "type": "string",
          "contentEncoding": "binary"
        }
      },
      "required": ["length", "body"],
      "additionalProperties": false
    }
  },

  "x-constants": {
    "MCP_FLOW_VERSION": "0.1",
    "RECOMMENDED_PATH": "/mcp-flow",
    "ALPN": "h3",
    "MIN_TLS_VERSION": "1.3",
    "MAX_DATAGRAM_PAYLOAD_SIZE": 1200,
    "DATAGRAM_CHANNEL_RESERVED": 0,
    "DATAGRAM_CHANNEL_PROGRESS": 1,
    "DATAGRAM_CHANNEL_AUDIO": 2,
    "DATAGRAM_CHANNEL_LOG": 3
  }
}
